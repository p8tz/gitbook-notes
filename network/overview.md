## 时延

时延指数据从网络一端传到另一端所需的时间

**发送时延**

发送时延（transmission delay）是主机或路由器发送数据帧所需要的时间，即从发送数据帧的第一个比特算起，到该帧最后一个比特发送完毕所需要的时间

$$发送时延 = \frac{数据帧长度(bit)}{发送速率(bit/s)}$$

**传播时延**

传播时延（propagation delay）是电磁波在信道中传播一定的距离需要花费的时间

$$传播时延 = \frac{信道长度(m)}{电磁波在信道上的传播速率(m/s)}$$

**处理时延**

处理时延是主机或路由器在收到分组时对其处理的时间，比如分析首部，提取数据部分，差错检测，查找路由

**排队时延**

排队时延是分组在路由器中排队等待处理的时间

## 体系结构

![image-20201101113800072](https://gitee.com/p8t/picbed/raw/master/imgs/20201101113801.png)

- **应用层** ：**为特定应用程序提供数据传输服务**，例如 HTTP、DNS 等协议。数据单位为报文。
- **传输层** ：**为进程提供通用数据传输服务。**由于应用层协议很多，定义通用的传输层协议就可以支持不断增多的应用层协议。运输层包括两种协议：传输控制协议 TCP，提供面向连接、可靠的数据传输服务，数据单位为报文段；用户数据报协议 UDP，提供无连接、尽最大努力的数据传输服务，数据单位为用户数据报。TCP 主要提供完整性服务，UDP 主要提供及时性服务。
- **网络层** ：为主机提供数据传输服务。而传输层协议是为主机中的进程提供数据传输服务。网络层把传输层传递下来的报文段或者用户数据报封装成分组。
- **数据链路层** ：网络层针对的还是主机之间的数据传输服务，而主机之间可以有很多链路，链路层协议就是为同一链路的主机提供数据传输服务。数据链路层把网络层传下来的分组封装成帧。
- **物理层** ：考虑的是怎样在传输媒体上传输数据比特流，而不是指具体的传输媒体。物理层的作用是尽可能屏蔽传输媒体和通信手段的差异，使数据链路层感觉不到这些差异。

## 物理层

### 信道复用技术

- 频分复用：用户在同样的时间占用不同的频带宽度

![image-20201101123531248](https://gitee.com/p8t/picbed/raw/master/imgs/20201101123532.png)

- 时分复用：用户在不同时间占用同样的频带宽度

![image-20201101123544055](https://gitee.com/p8t/picbed/raw/master/imgs/20201101123545.png)

- 统计时分复用：对时分复用的一种改进，不固定每个用户在时分复用帧中的位置
- 波分复用：光的频分复用。由于光的频率很高，因此习惯上用波长而不是频率来表示所使用的光载波。
- 码分复用

### 设备

**中继器**

对衰减的信号进行放大

**集线器**

对衰减的信号放大转发，相当于多口中继器

## 数据链路层

### 基本问题

**封装成帧**

将上层传下来的分组添加首部和尾部，用于标记帧的开始和结束，以及一些必要的控制信息。

**透明传输**

帧使用首部和尾部进行定界，如果帧的数据部分含有和首部尾部相同的内容，那么帧的开始和结束位置就会被错误的判定。需要在数据部分出现首部尾部相同的内容前面插入转义字符。如果数据部分出现转义字符，那么就在转义字符前面再加个转义字符。在接收端进行处理之后可以还原出原始数据。这个过程透明传输的内容是转义字符，用户察觉不到转义字符的存在。

**差错检测**

目前数据链路层广泛使用了循环冗余检验（CRC）来**检查**比特差错。需要在后面添加一个帧检验序列FCS。

### CSMA/CD协议

CSMA/CD 表示载波监听多点接入 / 碰撞检测。

- **多点接入** ：说明这是总线型网络，许多主机以多点的方式连接到总线上。
- **载波监听** ：每个主机都必须不停地监听信道。在发送前，如果监听到信道正在使用，就必须等待。
- **碰撞检测** ：在发送中，如果监听到信道已有其它主机正在发送数据，就表示发生了碰撞。虽然每个主机在发送数据之前都已经监听到信道为空闲，但是由于电磁波的传播时延的存在，还是有可能会发生碰撞。所以就需要边发送边监听。

### PPP协议

目前使用最广泛的数据链路层协议。数据报在网络上传输，在数据链路层的帧格式就是**PPP帧**。

### 以太网

以太网是一种星型拓扑结构局域网。通过交换机实现帧定向转发。

### MAC地址

硬件地址，每个适配器（网卡，计算机与外界网络连接的接口）都有的全球唯一的6字节地址

### 设备

交换机

交换机的前身是网桥。相比于物理层的中继器和集线器，交换机有一定的逻辑功能，它会根据MAC地址转发到对应的计算机上。

其工作原理是内部有一张交换表，交换表中存储着MAC地址到接口的映射。

## 网络层

网络层向上只提供简单灵活的、无连接的、尽最大努力交互的数据报服务。

使用 IP 协议，可以把异构的物理网络连接起来，使得在网络层看起来好像是一个统一的网络。

### IP地址分类

$$IP地址 = 网络号 + 主机号$$

![image-20201101152028782](https://gitee.com/p8t/picbed/raw/master/imgs/20201101152029.png)

### ARP协议

IP数据报在传输过程中，源IP和目的IP是不变的，当前MAC和目的MAC是不断变化的。因为MAC用于获取下一跳具体转发给哪台主机 / 路由器。

数据报传输过程中，需要知道目的IP和下一跳MAC地址。其中目的IP通过DNS查询获取，而下一跳MAC则会先查询自己的ARP高速缓存。如果查不到则会在本局域网内发送一个ARP广播分组，表示“我的IP是xxx，MAC是xxx，我想要找到IP为xxx主机对应的MAC地址”，然后那个目标的主机就会响应，再把数据报发送给它即可，同时把映射写入自己的高速缓存；如果目标主机不在本网段，则转发至对应路由器。

小结

ARP用于通过IP地址找到MAC地址，解决下一跳走哪的问题。ARP属于链路层和网络层之间的协议

如果目标主机在本网段，直接ARP解析，转发即可

如果目标主机不在本网段，则根据默认网关，转发至路由器

### ICMP协议

ICMP用于传输出错报告控制信息。它封装在 IP 数据报中，但是不属于高层协议。介于网络层和传输层之间。

![image-20201101161623700](https://gitee.com/p8t/picbed/raw/master/imgs/20201101161624.png)

ICMP 报文有两种，**ICMP差错报告报文**和**ICMP询问报文**。

差错报告报文

- 终点不可达
- 时间超过
- 参数问题
- 改变路由（Redirect）

询问报文

- 回送（Echo）请求或回答
- 时间戳（Timestamp）请求或回答

### 设备

**路由器**

多个输入端口多个输出端口的专用计算机，用于转发分组

## 传输层

网络层只把分组发送到目的主机，但是真正通信的并不是主机而是主机中的进程。传输层提供了进程间的逻辑通信，传输层向高层用户屏蔽了下面网络层的核心细节，使应用程序看起来像是在两个传输层实体之间有一条端到端的逻辑通信信道。

### UDP 和 TCP 的特点

用户数据报协议 UDP（User Datagram Protocol）是无连接的，尽最大可能交付，没有拥塞控制，面向报文（对于应用程序传下来的报文不合并也不拆分，只是添加 UDP 首部），支持一对一、一对多、多对一和多对多的交互通信。

传输控制协议 TCP（Transmission Control Protocol）是面向连接的，提供可靠交付，有流量控制，拥塞控制，提供全双工通信，面向字节流（把应用层传下来的报文看成字节流，把字节流组织成大小不等的数据块），每一条 TCP 连接只能是点对点的（一对一）。

### TCP首部格式

![image-20201101172734158](https://gitee.com/p8t/picbed/raw/master/imgs/20201101172735.png)

- **序号** ：用于对字节流进行编号，例如序号为 301，表示第一个字节的编号为 301，如果携带的数据长度为 100 字节，那么下一个报文段的序号应为 401。
- **确认号** ：期望收到的下一个报文段的序号。例如 B 正确收到 A 发送来的一个报文段，序号为 501，携带的数据长度为 200 字节，因此 B 期望下一个报文段的序号为 701，B 发送给 A 的确认报文段中确认号就为 701。
- **数据偏移** ：指的是数据部分距离报文段起始处的偏移量，实际上指的是首部长度。
- **确认 ACK** ：当 ACK=1 时确认号字段有效，否则无效。TCP 规定，在连接建立后所有传送的报文段都必须把 ACK 置 1。
- **同步 SYN** ：在连接建立时用来同步序号。当 SYN=1，ACK=0 时表示这是一个连接请求报文段。若对方同意建立连接，则响应报文中 SYN=1，ACK=1。
- **终止 FIN** ：用来释放一个连接，当 FIN=1 时，表示此报文段的发送方的数据已发送完毕，并要求释放连接。
- **窗口** ：窗口值作为接收方让发送方设置其发送窗口的依据。之所以要有这个限制，是因为接收方的数据缓存空间是有限的。

### TCP的三次握手

![image-20201101191541005](https://gitee.com/p8t/picbed/raw/master/imgs/20201101191542.png)

1. 客户端发送一个TCP报文, SYN = 1, ACK = 0 表明这是一个请求连接的报文。数据序号为x，数据长度为0。
2. 服务器收到请求连接报文后，发送确认报文，SYN = 1, ACK = 1。数据序号为y，由于客户端发送的请求报文数据长度为0且即使长度为0也要消耗一个序号，因此服务器期望客户端下一个发来的确认报文的序号为x + 1，即ack = x + 1。
3. 客户端收到确认报文后，还要向服务器发送确认报文。数据序号+1，期望服务器下个报文数据序号为y + 1。
4. 服务器收到客户端确认报文后，连接建立。

**三次握手的原因**

第三次握手是为了防止失效的连接请求到达服务器，让服务器错误打开连接。

客户端发送的连接请求如果在网络中滞留，那么就会隔很长一段时间才能收到服务器端发回的连接确认。客户端等待一个超时重传时间之后，就会重新请求连接。但是这个滞留的连接请求最后还是会到达服务器，如果不进行三次握手，那么服务器就会打开两个连接。如果有第三次握手，客户端会忽略服务器之后发送的对滞留连接请求的连接确认，不进行第三次握手，因此就不会再次打开连接。

### TCP的四次挥手

![image-20201101191527235](https://gitee.com/p8t/picbed/raw/master/imgs/20201101191528.png)

1. 客户端主动请求释放连接，发送释放连接报文，FIN = 1。
2. 服务器收到请求，发送确认报文，进入半关闭状态。此时客户端不能向
   服务器发送数据，但服务器可以向客户端发送数据，就是为了把可能剩
   下的数据发送完。
3. 服务器不再需要传输数据，发送释放连接报文，FIN = 1。
4. 客户端收到后发送确认报文，然后等待2个MSL（最大报文存活时间）后，
   释放连接。
5. 服务器收到确认报文后，释放连接。

**四次挥手的原因**

客户端发送了 FIN 连接释放报文之后，服务器收到了这个报文，就进入了 CLOSE-WAIT 状态。这个状态是为了让服务器端发送还未传送完毕的数据，传送完毕之后，服务器会发送 FIN 连接释放报文。

**TIME_WAIT**

客户端接收到服务器端的 FIN 报文后进入此状态，此时并不是直接进入 CLOSED 状态，还需要等待一个时间计时器设置的时间 2MSL。这么做有两个理由：

- 确保最后一个确认报文能够到达。如果 B 没收到 A 发送来的确认报文，那么就会重新发送连接释放请求报文，A 等待一段时间就是为了处理这种情况的发生。
- 等待一段时间是为了让本连接持续时间内所产生的所有报文都从网络中消失，使得下一个新的连接不会出现旧的连接请求报文。

## 应用层















## 参考资料

[计算机网络 谢希仁](https://item.jd.com/12219883.html)

[CS-Notes](https://cyc2018.github.io/CS-Notes/)