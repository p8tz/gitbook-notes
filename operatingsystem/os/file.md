> [操作系统原理](https://item.jd.com/12397357.html)

## 文件的组织结构

文件是信息的集合，保存在文件中的信息总按一定的方式组织起来。文件中信息的组织方式称为文件的组织结构，简称文件的结构。对任何一个文件都存在以下两种形式的组织结构。

（1）逻辑结构。文件的逻辑结构就是用户所看到的文件组织形式，是用户可以直接处理的数据及其结构。文件的逻辑结构独立于存放文件的物理介质，其组织目的是为用户提供一种结构清晰、操作方便的信息组织形式，以方便用户使用文件。

（2）物理结构。文件的物理结构是逻辑文件在外存上具体的存储方式，该存储方式与存放文件的物理介质有关。为文件设计物理结构的出发点是为了提高外存的利用率和文件的存取速度。
事实上，无论是文件的逻辑结构还是物理结构，其构造方式都对文件的存储空间和存取速度产生影响。

### 逻辑结构

文件的逻辑结构分为两大类：无结构文件和有结构文件。无结构文件中的信息不存在结构，所以也称字符流文件或流式文件；有结构文件由若干记录构成，所以又称记录式文件。

#### 1、流式文件

无结构的流式文件是有序字符的集合，即整个文件可以看成是字符流的序列，字符是构成文件的基本单位。流式文件一般按照字符组的长度来读写信息。

为了I/O操作的需要，流式文件中也可以通过插入一些特殊字符，将文件划分成若干字符分组，且将这些字符分组称为记录。但这些记录仅仅是字符序列分组，即并不改变流式文件中字符流序列本身的组织形式，而只是为了使信息传送方便所采用的一种传送方法。

在实际应用中，许多情况下都不需要在文件中引入记录，按记录方式组织文件反而会给操作带来不便。如用户写的源程序原本就是一个字符序列，强制将该字符序列按照记录序列组成文件，只会带来操作复杂、开销增大等缺点。

相对记录式文件而言，流式文件具有管理简单、操作方便等优点。但在流式文件中检索信息则比较麻烦，效率较低。因此对不需要执行大量检索操作的文件，如源程序文件、目标文件、可执行文件等，采用流式文件形式比较合适。

为了简化文件系统，现在大多数操作系统，如Windows、UNIX、Linux等只提供了流式文件。

#### 2、记录式文件

记录式的有结构文件是指用户把文件内的信息按逻辑上独立的含义划分为一个个信息单位，每个信息单位称为一个逻辑记录，即记录式文件是由若干逻辑记录构成的序列。从操作系统管理的角度看，逻辑记录是文件信息按逻辑上的独立含义划分的最小信息单位，使用者的每次操作总是以一个逻辑记录为对象。但从程序设计语言处理信息的角度看，逻辑记录还可以进一步分成一个或多个更小的数据项。数据项被看作不可分割的最小数据单位，数据项的集合构成逻辑记录，相关逻辑记录的集合又构成文件。因此数据项是文件最低级别的数据组织形式，常用于描述一个实际对象在某个方面的属性，而逻辑记录则描述了一个实际对象中人们关心的各方面属性。如某班学生信息文件中的一个逻辑记录包括学号、姓名、成绩等数据项，每个逻辑记录表示一个学生的基本信息，多个逻辑记录则构成一个班级的学生信息文件。

为了简化文件的管理和操作，大多数现代操作系统对用户只提供字符流式的无结构文件，记录式的有结构文件则由程序设计语言或**数据库管理系统**提供。

### 物理结构

#### 1、连续结构

连续结构也称顺序结构，是一种最简单的物理文件结构，其特点是**逻辑上连续的文件信息，依次存放在物理上相邻的若干物理块中。**

为了确定连续文件在磁盘上的存放位置，需要将该文件第一个物理块号及文件长度（物理块个数）等信息记录在文件目录中该文件所对应的目录项里。

优点是支持随机访问。

连续文件的缺点主要体现在以下4个方面。

（1）在交互应用场合，如果用户要求查找或修改文件中未知序号的某个记录，则系统只能按顺序依次查找连续文件中的相邻记录，直到找到所需记录为止，这时连续文件所表现出来的性能可能就很差，尤其是当文件较大时情况就更严重。如果是变长记录的连续文件，则为查找一个记录所需付出的开销将更大。

（2）为文件分配连续的存储空间容易出现外存碎片（随着文件存储空间的不断分配和回收，将导致磁盘上出现一些再也无法分配的小存储区，如仅有一两个物理块的存储区）。大量外存碎片的出现会严重降低外存空间的利用率，若定期利用紧凑技术来消除外存碎片，则要花费大量的CPU时间。

（3）要为文件分配连续存储空间，必须事先知道文件的长度，而许多情况下却难以事先知道文件的长度。

（4）增加或删除一个记录比较困难。在增加或删除记录后，需要调整文件中所有记录的存储位置来保持文件连续存储的特性。为了解决这一问题，可以为连续文件配置一个运行记录文件或称事务文件。需要对文件实施增加、删除或修改记录的操作时，并不立即对文件实施这些操作，而是将该操作的信息登记到运行记录文件中。每隔一定时间，系统则按照运行记录文件所记录的一系列操作对该文件实施这些操作，即将分散的各个操作集中起来，进行一次性处理，以此来提高处理的效率。

#### 2、链接结构

为了克服连续文件增加或删除记录比较困难且容易产生外存碎片的缺点，可以采用离散方式为文件分配外存空间。链接结构也称串联结构，它就是为了实现文件离散分配磁盘物理块而产生的一种文件物理结构。采用链接结构，文件的信息可以保存在磁盘的若干相邻或不相邻的物理块中，每个物理块中设置一个指针指向逻辑顺序的下一个物理块，从而使同一个文件中的各物理块按逻辑顺序链接起来。具有链接结构的物理文件称为链接文件或串联文件。

由于链接文件采用离散分配方式，从而消除了外存碎片，所以可显著提高外存（磁盘）空间的利用率。此外，链接文件不需要事先知道文件的大小，而是根据文件当前需求的大小来分配磁盘物理块。随着文件的动态增长，当文件需要新的物理块时再动态地为其追加分配，因此便于文件的增长和扩充；不需要文件中某物理块时，也可从该文件的物理块链中删除。链接文件可以动态分配物理块的特点决定了在这类文件中能够方便地进行插入、删除和修改操作。链接文件的缺点是只适合顺序访问而不能直接访问（随机访问），并且因每个物理块中的链接指针都要占一定的存储空间而导致存储效率降低。

根据链接方式的不同，链接结构又可以分为隐式链接结构和显式链接结构两种。

（1）隐式链接结构

采用隐式链接结构时，文件的每个物理块中有一个指针指向该文件中逻辑顺序的下一个物理块，即通过每个物理块中的指针将属于同一个文件的所有物理块链接成一个链表，并且将指向文件第一个物理块的指针保存到该文件的目录项中。

隐式链接文件的主要问题是只适合顺序访问，直接访问的效率很低。例如，若要访问文件的某个物理块，则必须先从它的第一个物理块起，沿着指针一个物理块接着一个物理块进行查找，直至找到所要访问的物理块为止，通常这种查找需要花费较多的时间。另外，仅通过链接指针将大量离散的物理块链接起来可靠性较差，一个指针出现了问题就会导致整个物理块链断开。

为了提高文件的检索速度和减少指针占用的存储空间，可以将相邻的几个物理块组成一个单位——簇，然后以簇为单位来分配磁盘空间。这样做的好处是成倍地减少了查找指定物理块的时间，同时也减少了指针占用的存储空间。不足之处是以簇为单位分配磁盘空间会使外存碎片增多。

（2）显式链接结构

显示链接结构就是按上述方法将用于链接文件各物理块的指针，显式地存放在内存中的一张链接表中，称为文件分配表（FAT）。文件分配表的设置方式是将**整个磁盘配置一张FAT**，该磁盘的每个物理块各对应一个 FAT表项，因此 FAT的项数与磁盘的物理块数相同。

显示链接结构由于使用了FAT保存磁盘中所有文件物理块之间的关联信息，因此可以按照以下方式存取文件的某个物理块：将 FAT读入内存并在 FAT中进行查找，待找到需要访问的物理块号后，再将该物理块的信息读入内存进行存取操作。由于整个查找操作在内存中进行，与隐式链接结构相比不仅提高了查找速度，而且大大减少了访问磁盘的次数。DOS和Windows操作系统的文件就采用了显示链接结构。

采用显示链接结构存在以下两个问题。

（1）随机存取的效率不高。这是因为当需要对一个大文件进行直接存取时，首先从文件目录项中该文件的第一个物理块号开始查找 FAT，即以顺序查找的方式在内存的FAT中找到需要存取的物理块号，虽然查找是在内存中进行，但这种顺序查找也可能花费较多的时间。

（2）由于整个磁盘配置一张FAT，而为了查找文件的物理块号就必须先将这个FAT读入内存，则当磁盘容量较大时这个FAT也会占用较多的内存空间。

#### 3、索引结构

FAT虽然有效但占用内存较多，因为**FAT记录了整个磁盘的所有物理块号**，但如果系统中的文件数量较小，或者每个文件都不太大，那么FAT中将有很多未为文件使用的空表项，这样将整个FAT都放入内存显然没有必要。如果能将一个文件占用的所有物理块磁盘地址收集起来，集中放在一个索引物理块中，而在文件打开时将这个索引物理块加载到内存，这样就可以从内存索引物理块中获得文件的任何一个物理块磁盘地址。由于内存中存放的只是我们当前使用文件索引物理块，而不使用的那些文件的索引物理块仍在磁盘上，因此，显示链接结构中FAT占用内存太多的问题就解决了，这种索引物理块的方式就是索引结构。

索引结构的组织方式是：文件中的所有物理块都可以离散地存放于磁盘中，系统为每个文件建立一张索引表，用于按逻辑顺序存放该文件占用的所有物理块号。索引表或者保存在文件的目录项（即文件控制块 FCB）中，或者保存在一个专门分配的物理块（索引物理块）中，这时文件目录中只含有指向索引物理块的指针（即索引物理块的块号）。具有索引结构的文件称为索引文件。

## 文件共享

文件共享是指多个用户（进程）可以通过相同或不同文件名使用同一个文件，这样系统只需保存该文件的一份副本。利用文件共享不仅可以节省大量外存空间，而且可以减少复制文件的时间开销并减少文件中数据不一致性的问题发生。

### 基于索引节点的文件共享（硬链接）

当多个用户需要共享某文件（或子目录）时，必须将被共享的文件（或子目录）链接到这些用户的相应目录中，以便能够方便地找到被共享的文件（子目录）。然而，用户与被共享文件之间的链接关系必须使用正确的方法来实现，否则就可能出现部分文件内容并不能被共享的问题。例如，若有两个用户分别希望以文件名A和文件名B来共享文件C，则必须实现文件A或文件B与文件C之间的链接；若链接方法是将文件C的物理地址（即物理块号）分别复制到文件A或文件B的目录项中，则这种链接方式可能会导致无法共享文件C中新添加的数据。这是因为如果使用文件A的用户向文件C中添加新的数据时，可能会导致系统为文件A分配新的物理块，而这些新增加的物理块号信息只会出现在用户文件A的目录项中，这样，文件 B的目录项中就没有这些新增加的物理块号信息，即文件 C新增加的内容对使用文件B的用户是不可见的，也即文件C新增加的内容不能被共享。

实现文件共享的一种正确方法是使用索引节点，即除文件名外的其他全部属性不再保存在文件的目录项中，而是保存在索引节点中。文件的目录项只保留文件名和指向该文件索引节点的指针。

为了共享文件，索引节点中设置了一个链接计数器 count，用来记录链接到本索引节点上的目录项数目。例如，若 count=2，则表示有两个用户目录项链接到本索引节点上，也即有两个用户在共享本文件。

当一个用户创建文件C后，此用户就是文件C的所有者，此时文件C的索引节点中count=1。当另一个用户需共享文件 C时，就在自己的文件目录中增加一个目录项，同时设置一个指针指向文件C的索引节点，并置索引节点的count=2。增加共享用户不会导致文件的所有者发生改变，只是文件C中索引节点里的count值相应增加。用户删除共享文件C时，只要其索引节点中的count值大于1，就不能真正删除共享文件C，只能删除该用户目录到共享文件C索引节点的链接，并将共享文件C中索引节点里的count值减1。只有共享文件C再没有被其他用户共享时（count=1），才能真正由文件 C的所有者删除。**这种基于索引节点的文件共享方式，使得共享文件的所有者在其他用户共享该文件时无法删除它。**

### 基于符号链的文件共享（软链接）

文件硬链接不利于文件所有者（文件主）删除他拥有的文件，因为文件主在删除他拥有的共享文件时，就必须先删除（关闭）所有其他用户的硬链接，否则就会造成共享该文件的其他用户目录表中的指针悬空（空指针，所指的共享文件为不存在的文件）。为此又提出了另一种链接方法——符号链接。

利用符号链接也可以实现文件共享，类似于windows下的快捷方式。需要链接文件A时，由系统创建一个link类型的新文件B，新文件中只包含被链接文件A的路径名。当用户访问B时，自动重定向到A的路径。

利用符号链接实现文件共享时，只有共享文件的所有者才拥有指向该共享文件索引节点的指针，其他共享该共享文件的用户只有其路径名，而没有指向其索引节点的指针。这样，当共享文件的所有者删除该共享文件时并不会受其他共享用户的影响，只是该共享文件被删除后，其他用户要通过符号链去访问此共享文件时，会因找不到这个共享文件而访问失败，此时系统将该用户文件目录中访问该共享文件的这个符号链接（即link类型的文件）删除。

利用符号链接实现文件共享的最大优点是：只要知道文件所在计算机的网络地址及其文件在该计算机上的路径，就能够通过网络链接到世界上任何地方的计算机中所存放的文件。

利用符号链接实现文件共享的主要缺点是：当用户通过符号链接访问某个共享文件时，系统需要根据给定的文件路径名逐个路径分量地去多次查找目录，直至找到需要访问的共享文件的索引节点，整个过程可能要多次读取磁盘，从而使访问操作的开销很大。此外，利用符号链接实现文件共享时要为每个共享用户建立一条符号链接，每个符号链接是一个文件，尽管其内容简单，但也要为它分配索引节点而耗费一定的磁盘空间。

### 小结

基于索引节点以及符号链接的共享方法都存在一个共同问题，即每个共享文件都可能有多个文件名，也就是说，每增加一个链接就增加一个文件名，实质上就是每个用户都使用自己的路径名去访问共享文件。因此会产生这样一个问题，即当需要将一个目录中的所有文件都转储到磁带上时，就可能使一个共享文件产生出多个副本（一个共享文件以不同的文件名存储了多次）。

