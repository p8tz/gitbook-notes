> [操作系统原理](https://item.jd.com/12397357.html)

## IO设备控制方式

提高CPU与I/O设备并行操作的能力是推动I/O设备控制方式发展的主要动力。随着计算机技术的发展，I/O控制方式也在不断更新，从早期的程序直接 I/O控制方式逐渐发展出了中断I/O控制方式、DMA I/O控制方式和通道I/O控制方式。I/O控制方式的整个发展过程始终贯穿着一条宗旨：尽量减少CPU对I/O操作的干预，将CPU从繁忙的I/O任务中解脱出来，更大程度上实现CPU与I/O设备并行工作。

### 1、轮询

早期计算机系统中没有中断系统，CPU对I/O设备的控制只能由程序直接控制，但由于传输数据时CPU的速度明显快于I/O设备，于是CPU需要不断测试I/O设备，只有当设备空闲时才能进行数据传送，这种控制方式称为**程序直接 I/O控制方式**，又称为查询方式或忙-等待方式。

程序直接I/O控制方式由用户进程直接控制内存或CPU与外设之间的信息传送。当用户进程需要传送数据时通过 CPU向设备发出启动指令，用户进程进入测试等待状态。CPU不断地执行I/O测试指令测试设备的状态，即采用循环测试I/O方式直接控制外设传输信息。也即，利用I/O测试指令测试设备的忙/闲标志位，若设备不忙，则执行I/O操作并完成数据的传送；若设备忙，则 I/O测试指令不断对它进行测试，直到设备空闲为止。这种控制方式也称循环测试I/O方式。

由于CPU的速度比I/O的速度快得多，而循环测试I/O方式使得CPU与外设只能**串行工作**，因此CPU绝大部分时间都处于等待I/O数据传输完成的循环测试状态，极大地浪费了CPU资源。另外，这种控制方式使设备与设备之间也只能串行工作。但是，循环测试I/O方式的优点是管理简单，在CPU速度不是很快而且外设种类不多的情况下常被采用。

### 2、中断

**程序中断 I/O控制方式。**由于循环测试 I/O方式中的外设是被动控制对象，因此CPU需要对其进行连续监控。计算机系统引入中断技术后可以增加I/O设备的主动性，即每当设备完成I/O操作时就以中断请求方式主动向CPU汇报，同时CPU内部也增加了检测中断和自动响应中断的功能，于是产生了新的 I/O控制方式，即中断 I/O控制方式。CPU在启动I/O设备之后可以转去执行其他程序，仅在接到I/O中断请求时再花费极少时间来处理该中断。如从键盘上输入一个字符的时间约需 100ms，将字符从设备控制器送入内存键盘缓冲区的时间小于0.1ms。若采用程序直接I/O控制方式，则CPU有99.9ms处于循环等待之中；而采用中断处理方式，CPU仅需花0.1ms时间来处理I/O设备发出的中断请求，其余99.9ms时间可以去做其他事情。

中断I/O控制方式在一定程度上实现了CPU与外设并行，同时还可以实现多台外设之间的并行，从而提高了计算机系统的工作效率。即有了中断的硬件支持，CPU和I/O设备之间可以并行工作，CPU不再需要循环测试，而 I/O设备则自行传输数据。当一个单位（字或字节）的数据传输结束时，I/O设备（控制器）再向CPU发出中断，CPU接到中断后进行相应的处理，如果数据还未传输完毕则按照上述过程继续传输数据。

在中断I/O控制方式中，设备的工作在很大程度上仍依赖于CPU的直接控制，**设备每传输一个单位（字或字节）的数据，CPU都要对其进行一次中断处理，**即需要进行保护现场、提取数据、恢复现场等操作，这些操作仍然要占用CPU的时间。若系统支持的I/O设备很多，则CPU将陷入繁忙的I/O事务处理中。尤其对高速的块设备，如光盘、磁盘和磁带等数据交换是成批进行的，且单位数据之间的传送间隔时间较短，采用中断处理方式就有可能造成数据丢失。**这种频繁地处理I/O中断，就是中断I/O控制方式的不足。**

### 3、DMA

虽然中断 I/O控制方式消除了程序直接 I/O控制方式的重复测试，但数据传输仍以字（字节）为单位，即设备每完成一个字（字节）的传输后，设备控制器就要向 CPU发一次中断。另外，内存与设备控制器之间传送数据仍需要 CPU干预。尽管这种控制方式可以满足低速字符设备的I/O要求，但用于块设备的I/O却十分低效。

目前在块设备的 I/O系统中，普遍采用**直接内存访问**（Direct Memory Access）I/O控制方式，即 DMA控制方式。在该方式中，**外部设备在DMA控制器支持下绕过 CPU直接与内存交换数据，每次交换可以传送一个数据块，在每个数据块的传送期间无须CPU的干预。**DMA控制方式下的地址总线和数据总线以及一些控制信号线都是与CPU共用的。平时这些总线和控制信号线由 CPU管理使用，当采用 DMA进行直接内存数据交换时，DMA采取挪用CPU工作周期和DMA控制器总线控制权的方法，由DMA控制器接管CPU所管理的总线，然后由DMA控制器控制外部设备与内存之间的成批数据传送，在所有数据传送完成后由 CPU回收总线控制权。即 DMA控制方式进一步减少了CPU对I/O过程的干预，**从每传输一个字（字节）干预一次减少到每传输一个数据块干预一次。**因此这是一种效率很高的传输方式。

DMA控制方式具有以下三方面特点。

（1）**内存与设备之间以数据块为单位进行数据传输，即每次至少传输一个数据块。**

（2）DMA控制器获得总线控制权而直接与内存进行数据交换，CPU不介入数据传输事宜。

（3）**CPU仅在数据块传送的开始和结束时进行干预，**而数据块的传输和I/O管理均由DMA控制器负责。

注意，DMA控制方式实际上有以下三种。

（1）周期窃取方式。在每一条指令执行结束时，CPU测试有无DMA服务申请，如果有，则CPU进入一个DMA周期，即借用一个CPU的工作周期来完成数据交换工作。采用周期窃取方式内存不与外部设备直接相连接，而只与 CPU连接，外部设备与内存的数据交换与程序直接I/O控制方式和程序中断I/O控制方式一样都要占用CPU的时间。

（2）直接存取方式。真正的 DMA控制方式，DMA控制器的数据传送申请不是发向CPU，而是直接发往内存。在得到内存的响应之后，整个数据传送工作全部在 DMA控制器中用硬件完成。

（3）数据块传送方式。数据块传送方式是一次传送一个数据块，即在每次中断 I/O过程中是以数据块为单位获得或发送数据的，这一点与上面两种 DMA控制方式相同，因此通常也把这种I/O方式归入DMA控制方式。

需要注意的是，直接存取方式是在设备控制器中设置一个比较大的数据缓冲存储器，一般要能够存放下一个数据块，设备控制器与内存之间的数据交换以数据块为单位，一次传送一批数据，并采用程序中断方式进行，这一点与一次只传送一个数据块的数据块传送方式不同。

### 4、通道

虽然 DMA控制方式能够满足高速数据传输的需要，但每传送一个数据块都需要向CPU发出中断，且在每个数据块的传送开始或结束时，CPU都要介入其中进行处理，以实现 CPU与设备的并行操作，因此效率仍不够高。此外 CPU发出的每条 I/O指令只能读、写同一内存区域中的连续数据块，不能满足复杂 I/O操作的需求。如当人们希望一次读取位于磁盘不同位置上的多个数据块，并将它们分别传送到内存的不同区域时，则需要CPU多次发出I/O指令，并进行多次中断处理才能完成传送。另一方面，随着计算机的发展和应用范围的不断扩大，需要 CPU与外设之间具有更高的并行能力，同时也能够使种类繁多、物理特性各异的外部设备以标准接口的方式连接到系统中。因此计算机系统引入了通道结构。

通道是继DMA之后让CPU摆脱I/O操作的又一种好方法。在DMA控制方式中，对I/O设备的管理和某些操作仍然由CPU控制，此外，在多个设备之间也无法共享DMA控制器。I/O通道是专门管理I/O的硬件，它将CPU从繁忙的I/O事务中彻底解脱出来，实现 CPU、通道、设备并行操作。I/O通道可以控制多台设备共享设备控制器，从而实现多台设备与内存交换数据。I/O通道控制方式与 DMA控制方式类似，也是以内存为中心实现数据在设备与内存的直接交换。在 I/O通道控制方式下，**当进程发出 I/O请求后，只需给CPU指出通道相应的操作和使用的I/O设备，即可执行启动通道的指令来启动通道，**并从内存中调出相应的通道程序予以执行。此时CPU将该I/O请求任务交由通道控制完成，当整个I/O任务在通道控制下完成之后，再由通道发出中断请求信号，此时CPU响应中断并进行后续处理。因此I/O通道进一步减少了CPU对I/O过程的干预，既减轻了CPU的工作负担，也提升了计算机系统的并行工作能力，使现代计算机系统的功能更加完善。正是有了中断技术和通道技术，才真正实现了CPU与I/O设备的并行工作，由此也真正实现了多道程序设计。

通道方式与DMA方式类似，是DMA方式的进一步发展。但**通道方式与DMA方式不同的是：在 DMA方式中，数据的传送方向、存放数据的内存起始地址以及传送的数据块长度等都由CPU控制；而在通道方式中，这些操作都由专门负责I/O操作的硬件——通道来实现。**通道实现了在 I/O设备与内存之间直接进行数据的交换，**和 DMA方式相比，通道使 CPU从以数据块为单位的干预，减少到仅当全部数据交换完成后只干预一次。**在DMA方式下，每个设备都配置一个专用的 DMA控制器，只能进行固定的数据传输操作；而通道方式则有自己的指令，即通道命令，能够根据通道程序控制多个外部设备，从而提供了多个设备共享一个DMA的功能。

### 小结

（1）轮询。优点是控制简单，也不需要很多硬件支持。缺点是CPU和外部设备之间只能串行工作，且 CPU的大部分时间都处于循环测试状态，这使得 CPU的利用率大为降低。由于 CPU在一段时间内只能与一台外部设备交换数据，因此不能实现设备之间的并行工作。此外，程序直接 I/O控制方式通过测试设备的状态标志来控制数据的传送，所以无法发现和处理因设备或其他硬件所产生的错误。因此程序直接 I/O控制方式只适用于那些CPU执行速度较慢且外部设备不多的系统。

（2）中断。优点是能够实现CPU与设备之间、设备与设备之间的并行操作，CPU的利用率较程序直接I/O控制方式大为提高。缺点是I/O控制器的数据缓冲寄存器通常较小，且数据缓冲寄存器每当装满数据时都会发出中断，这使得完成一次数据传送发生的中断次数过多而耗费大量的 CPU时间。如果系统配置的外部设备较多，且都采用中断I/O控制方式进行并行操作，则将消耗大量的CPU时间，并且有可能因CPU来不及处理而造成数据丢失。

（3）DMA。与中断控制方式相比，DMA控制方式的优点是在一个数据块的数据传送完成后中断一次 CPU，从而减少了 CPU中断处理的次数，并且 DMA控制方式下的数据传送是在 DMA控制器控制下完成的，在每个数据块的传送过程中无须CPU干预，而是在每个数据块传送完毕后发出中断，显然，DMA控制方式的效率要高得多。缺点是DMA控制仍有一定的局限性，即**每传送完一个数据块都要向CPU发出中断**，这使得在每个数据块传送结束时 CPU都需要切换回来进行相应的处理，即以来回切换的方式实现与外部设备的并行操作，因此效率仍不够高。此外，对外部设备的管理仍然需要由CPU完成，并且使用多个DMA控制器也不够经济。

（4）通道。优点是CPU只需发出I/O指令，通道就能完成相应的I/O操作，并且只在整个数据传送操作结束时向 CPU发出中断。由此可见，CPU仅在 I/O操作开始和结束时花较短的时间处理与 I/O有关的事宜，而其余时间里，通道进行数据传送而CPU则做其他工作，即实现了 CPU与通道的并行工作，且通道与通道之间也实现了并行操作。此外，一个通道还可以控制多台外部设备，从而极大地提高了整个计算机系统资源的利用率。缺点是通道价格较高，从经济角度考虑不宜过多使用。